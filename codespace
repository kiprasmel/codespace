#!/usr/bin/env bash

set -euo pipefail

test -z "${DEBUG:-}" || set -x

DIRNAME="$(dirname "$(realpath "$0")")"

# shellcheck source=codespace-utils
source "$DIRNAME/codespace-utils"

# shellcheck source=codespace-worktree
CS_WORKTREE_NO_RUN=1 source "$DIRNAME/codespace-worktree"

# shellcheck source=codespace-stack
CS_STACK_NO_RUN=1 source "$DIRNAME/codespace-stack"

# shellcheck source=codespace-find
CS_FIND_NO_RUN=1 source "$DIRNAME/codespace-find"

HELP="\
Usage:
codespace <branch> [-b base] [--clone [clone_url]]
codespace <sub-command>

  <branch>  can be existing (won't modify), or new (will create).

optional flags:
  -b, --base <branch>
            base branch to create from (default: remote HEAD).
  --clone [clone_url]
            create a standalone clone instead of a worktree.
            benefits: allows other checkouts/rebases in main repo,
            better for one-off initialization on remote systems.
            [clone_url] - inferred from remote if inside a git repo.


env vars:
  GUI_EDITOR or EDITOR  - for opening a newly created codespace in an editor.

  CODESPACE_CONFIG_ROOT - dir where configs for codespaces are placed.
                          used to configure post-create scripts, link hidden files, etc.
                          layout of the dir should be: \"/org/repo/\" (see also base-repo).
                          inside:
                            - files, scripts, etc that are not in the repo itself.
                            - \".codespace/post-create\" script - ran on codespace creation.

  CS_NO_INTERACTIVE     - if set, skip interactive prompts and use defaults.
                          inferred if CURSOR_AGENT or CI is set.

  CS_NO_FETCH           - if set, skip fetching remote before creating worktree.
                          by default, fetches the base branch before creating.

  CS_DEFAULT_CREATE_TYPE
                        - what 'codespace create' defaults to.
                          \"worktree\" (default) or \"stack\".

  DEBUG                 - if set, prints every command executed.


.git files:
  CODESPACE_IS_CLONE    - marker file created in .git/ when using 'create' with '--clone'.


sub-commands:
  c, create   <branch> [-b base]
                                - alias for worktree or stack create.
                                  (see CS_DEFAULT_CREATE_TYPE, default: worktree)
  wt, worktree [create] <branch> [-b base] [--clone [url]]
                                - create a single-repo codespace (worktree or clone).
  s, stack    [create] <branch> - create a multi-repo codespace (stack).
                                  see 'codespace stack --help' for details.
  post-create [cs_path]         - run the post-create script for a given codespace.
                                  [cs_path] defaults to codespace inside cwd.
  rm, remove  <branch|path>     - remove a codespace (worktree or clone).
                                  checks for uncommitted/unpushed changes before removing.
                                  [-f, --force] - ignore safety checks.
  find        <branch>          - find codespace/stack path by branch name.
  edit        <branch>          - find codespace/stack and open in editor.
  config                        - absolute path of config dir of the repo
  config init                   - init config dir + post-create script for current repo.
  repo-id     [rel_to]          - get the repo ID to locate appropriate config location
                                  in \"\$CODESPACE_CONFIG_ROOT\".
                                  assumes that repositories are placed in \"\$HOME/org/repo\"
                                  (controllable via [rel_to], which defaults to \"\$HOME\").
                                  extracts \"/org/repo\" portion of \"\$PWD\" wrt [rel_to].
  base-repo                     - absolute path to the root of the base repository.
  cleanpath   <string>          - sanitize path for worktree dir (replace /, :, spaces etc)
  is-checkout-not-worktree      - prints 1 if we are in a branch checkout in the main repo,
  hide     <file> <file2>...    - add file(s) to .git/info/exclude (local gitignore).
                                  note: affects not only the worktree, but the base repo.
"

main() {
	test $# -ge 1 || {
		>&2 echo "$HELP"
		exit 1
	}

	cmd="$1"
	shift

	while [ $# -ge 0 ]; do
		case "$cmd" in
			c|create) cs_create_dispatch "$@"; break ;;
			w|wt|worktree) cs_worktree_main "$@"; break ;;
			s|stack) cs_stack_main "$@"; break ;;
			post-create) cs_post_create "$@"; break ;;
			post-create.link-files-from-repo) cs_post_create__link_files_from_repo "$@"; break ;;
			post-create.link-files-from-config) cs_post_create__link_files_from_config "$@"; break ;;
			rm|remove) cs_remove "$@"; break ;;
			find) cs_find "$@"; break ;;
			edit) cs_edit "$@"; break ;;
			base-repo) cs_abs_path_base_repo "$@"; break ;;
			repo-id) cs_repo_id "$@"; break ;;
			config)
				if [ $# -ge 1 ] && [ "$1" = "init" ]; then
					shift
					cs_config_init "$@"
				else
					cs_config_path "$@"
				fi
				break ;;
			cleanpath) cs_cleanpath "$@"; break ;;
			is-checkout-not-worktree) cs_are_we_in_checkout_not_worktree "$@"; break ;;
			hide) for f in "$@"; do cs_git_exclude_add "$f"; done; break ;;
			-h|--help) echo "$HELP"; exit 0 ;;
			*) cs_create_dispatch "$cmd" "$@"; break ;;
		esac
	done
}

# Dispatch create command based on CS_DEFAULT_CREATE_TYPE
cs_create_dispatch() {
	case "${CS_DEFAULT_CREATE_TYPE:-worktree}" in
		s|stack) cs_stack_main "$@" ;;
		*) cs_worktree_create "$@" ;;  # worktree (default)
	esac
}



##################
#                #
#  BEGIN CONFIG  #
#                #
##################

cs_config_init() {
	test -n "$CODESPACE_CONFIG_ROOT" || {
		>&2 echo "err: env var '\$CODESPACE_CONFIG_ROOT' not set, cannot initialize config"
		exit 1
	}

	CONFIG_PATH="$(cs_config_path)"

	if [ -d "$CONFIG_PATH" ]; then
		>&2 echo "Config directory already exists at: $CONFIG_PATH"
		exit 0
	fi

	CODESPACE_PATH="$CONFIG_PATH/.codespace"
	POST_CREATE_PATH="$CODESPACE_PATH/post-create"

	mkdir -p "$CODESPACE_PATH"

	echo "$POST_CREATE_SCRIPT_TEMPLATE" > "$POST_CREATE_PATH"
	chmod +x "$POST_CREATE_PATH"

	echo "config path: $CONFIG_PATH"
	echo "post-create script path: $POST_CREATE_PATH"
}

POST_CREATE_SCRIPT_TEMPLATE='\
#!/usr/bin/env bash

set -xeuo pipefail

REPO_FILES=".env"
LAYER2_FILES="AGENTS.md"

codespace post-create.link-files-from-repo $REPO_FILES
codespace post-create.link-files-from-config $LAYER2_FILES

# .. repo setup scripts ..
'

################
#              #
#  END CONFIG  #
#              #
################




###############
#             #
#  BEGIN LIB  #
#             #
###############

# expose convenience functions to be used in config scripts
cs_post_create__link_files_from_repo() {
	# skip if clone mode (no base repo to link from)
	if [ -n "$(cs_clone_marker)" ]; then
		>&2 echo "warn: skipping link-files-from-repo in clone mode (no local base repo)"
		return 0
	fi

	BASE_REPO_DIR="$(cs_abs_path_base_repo)"

	# skip if we are in a checkout
	# (we're already in the repo - we would link from ourselves to ourselves)
	test "$(cs_are_we_in_checkout_not_worktree)" = "1" && return

	for file in "$@"; do
		ln -s "$BASE_REPO_DIR/$file" "./$file" || :
	done
}
cs_post_create__link_files_from_config() {
	LAYER2_CONFIG_PATH="$(cs_config_path)"

	for file in "$@"; do
		ln -s "$LAYER2_CONFIG_PATH/$file" "./$file" || :
		cs_git_exclude_add "$file"
	done
}

# hide files from git
cs_git_exclude_add() {
	file="$1"
	exclude_file="$(git rev-parse --git-common-dir)/info/exclude"

	# add to exclude if not already present (exact line match)
	if ! grep -qxF "$file" "$exclude_file"; then
		echo "$file" >> "$exclude_file"
	fi
}

#############
#           #
#  END LIB  #
#           #
#############


main "$@"
exit $?
